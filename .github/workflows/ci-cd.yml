test:
  runs-on: ubuntu-latest
  needs: lint
  services:
    postgres:
      image: postgres:15
      env:
        POSTGRES_USER: postgres
        POSTGRES_PASSWORD: password
        POSTGRES_DB: log430
      ports:
        - 5432:5432
      options: >-
        --health-cmd pg_isready
        --health-interval 10s
        --health-timeout 5s
        --health-retries 5

  steps:
    - uses: actions/checkout@v3
    - uses: actions/setup-node@v3
      with:
        node-version: 20

    - name: Install dependencies
      run: npm ci

    - name: Start Docker services
      run: docker compose up -d

    - name: Wait for container to be ready
      run: sleep 10

    - name: Run tests inside container
      run: docker compose exec app npx jest
